@{
    ViewData["Title"] = "Group Chat";
}

<div class="row h-100 g-0">
    <!-- Sidebar: Channels -->
    <div class="col-md-3 border-end bg-white border-opacity-10 glass rounded-start-3" style="height: calc(100vh - 120px); min-height: 600px; overflow-y: auto;">
        <div class="p-3">
            <h5 class="fw-bold mb-4 d-flex align-items-center">
                <i data-feather="hash" class="me-2 text-primary"></i> Channels
            </h5>
             <!-- Create New Section (Moved to Top) -->
            <form asp-action="CreateGroup" method="post" class="mb-4">
                <label class="form-label small text-muted">Create New Channel</label>
                <div class="input-group input-group-sm">
                    <input type="text" name="name" class="form-control" placeholder="Channel name">
                    <button class="btn btn-primary"><i data-feather="plus"></i></button>
                </div>
            </form>

            <div class="list-group list-group-flush mb-4" id="channelList">
                 @if(ViewBag.Groups != null) 
                 {
                     foreach(var g in ViewBag.Groups)
                     {
                         <a href="#" class="list-group-item list-group-item-action group-link border-0 rounded-3 mb-1 @(g == "General" ? "active" : "")" data-group="@g">
                             <i data-feather="chevron-right" class="me-2" style="width: 14px;"></i> @g
                         </a>
                     }
                 }
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9 d-flex flex-column bg-white bg-opacity-10 glass rounded-end-3" style="height: calc(100vh - 120px); min-height: 600px;">
        <!-- Chat Header -->
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white bg-opacity-25">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <h6 class="mb-0 fw-bold" id="currentRoomName"># General</h6>
                    <small class="text-success" style="font-size: 0.7rem;">
                        <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true" style="width: 8px; height: 8px;"></span> Live Polling
                    </small>
                </div>
                <!-- Search Box -->
                <div class="input-group input-group-sm me-2" style="max-width: 250px;">
                    <span class="input-group-text bg-transparent border-end-0"><i data-feather="search" style="width:14px;"></i></span>
                    <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Search messages..." onkeyup="handleSearch(this.value)">
                </div>
                <!-- Star Filter Toggle -->
                <button id="starFilterBtn" class="btn btn-sm btn-light border text-muted" onclick="toggleStarredView()" title="Show Starred Messages">
                    <i data-feather="star" style="width:14px; height:14px;"></i>
                </button>
            </div>
            <div class="d-flex align-items-center">
                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.8rem;">
                    @(ViewBag.CurrentUserName?.Substring(0, 1).ToUpper())
                </div>
                <span class="fw-bold small">@ViewBag.CurrentUserName</span>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="flex-grow-1 p-4" id="chatArea" style="overflow-y: auto; background-color: rgba(0,0,0,0.02);">
            <div id="messagesList" class="d-flex flex-column gap-3">
                <!-- Messages will be injected here -->
            </div>
        </div>

        <!-- Chat Footer: Input -->
        <div class="p-3 bg-white bg-opacity-25 border-top">
            <div class="d-flex gap-2">
                <button class="btn btn-light border" onclick="document.getElementById('fileInput').click()" title="Upload Image">
                    <i data-feather="image"></i>
                </button>
                <input type="file" id="fileInput" class="d-none" onchange="uploadFile()">
                <textarea id="messageInput" class="form-control" placeholder="Type a message to #General..." rows="2" style="resize: none; border-radius: 10px;"></textarea>
                <button id="sendButton" class="btn btn-primary px-4 rounded-3">
                    <i data-feather="send"></i>
                </button>
            </div>
            <input type="hidden" id="currentGroup" value="General" />
        </div>
    </div>
</div>

<style>
    .message-bubble {
        max-width: 85%; /* Increased width for better mobile view */
        padding: 12px 16px;
        border-radius: 16px;
        position: relative;
        font-size: 0.95rem;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column; /* Stack content and time */
        min-width: 120px; /* Ensure space for short messages + time */
    }
    .message-me {
        align-self: flex-end;
        background: var(--aws-orange); 
        color: white;
        border-bottom-right-radius: 4px;
    }
    /* Ensure links in user messages are readable */
    .message-me a { color: white; text-decoration: underline; }

    .message-others {
        align-self: flex-start;
        background: white;
        color: var(--aws-dark);
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(0,0,0,0.08);
    }
    .message-info {
        font-size: 0.7rem;
        opacity: 0.7;
        font-weight: 500;
        align-self: flex-end; /* Align time to the right */
        margin-top: 4px;
        line-height: 1;
    }
    .group-link.active {
        background-color: rgba(255, 153, 0, 0.1) !important;
        color: var(--aws-orange) !important;
        font-weight: bold;
        border-left: 3px solid var(--aws-orange);
    }
    .chat-img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .chat-img:hover {
        transform: scale(1.01);
    }
    
    /* New Attachment Card Styles */
    .attachment-card {
        background: #fff;
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        min-width: 220px;
        max-width: 300px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* Override for 'me' messages to ensure card looks good inside orange bubble */
    .message-me .attachment-card {
        background: rgba(255,255,255,0.95);
        color: #333; /* Always dark text inside card */
    }

    .attachment-icon-wrapper {
        width: 36px;
        height: 36px;
        background: #f1f3f5;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .attachment-info {
        flex-grow: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        line-height: 1.2;
    }
    
    .attachment-name {
        font-weight: 600;
        font-size: 0.85rem;
        color: #333;
    }
    
    .attachment-size {
        font-size: 0.7rem;
        color: #6c757d;
    }

    .star-btn {
        transition: all 0.2s;
        visibility: visible;
        opacity: 0.3;
    }
    .msg-row:hover .star-btn {
        opacity: 1;
    }
    .star-btn:hover {
        transform: scale(1.1);
    }
</style>

<script>
    var currentUser = "@ViewBag.CurrentUserName";
    var currentGroup = "General";
    var chatArea = document.getElementById("chatArea");
    var isScrolledToBottom = true;
    var lastMessageCount = 0;
    var currentSearch = "";
    var showOnlyStarred = false;

    function handleSearch(val) {
        currentSearch = val;
        document.getElementById("messagesList").innerHTML = '';
        lastMessageCount = 0;
        fetchMessages();
    }

    function toggleStarredView() {
        showOnlyStarred = !showOnlyStarred;
        var btn = document.getElementById("starFilterBtn");
        if(showOnlyStarred) {
            btn.classList.add("text-warning");
            btn.classList.remove("text-muted");
        } else {
            btn.classList.remove("text-warning");
            btn.classList.add("text-muted");
        }
        document.getElementById("messagesList").innerHTML = '';
        lastMessageCount = 0;
        fetchMessages();
    }

    function toggleStar(msgId, element) {
        var formData = new FormData();
        formData.append("id", msgId);
        fetch('/Chat/ToggleStar', { method: 'POST', body: formData })
        .then(() => {
            var icon = element.querySelector('svg');
            if(element.classList.contains('text-warning')) {
                element.classList.remove('text-warning');
                element.classList.add('text-muted');
                if(icon) {
                    icon.style.fill = 'none';
                    icon.classList.remove('text-warning');
                }
            } else {
                element.classList.remove('text-muted');
                element.classList.add('text-warning');
                if(icon) {
                    icon.style.fill = 'currentColor';
                }
            }
        });
    }

    function fetchMessages() {
        var group = document.getElementById("currentGroup").value;
        var url = '/Chat/GetMessages?groupName=' + group;
        if(currentSearch) url += '&search=' + encodeURIComponent(currentSearch);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                var list = document.getElementById("messagesList");
                
                // Client-side filtering for Starred if active
                if(showOnlyStarred) {
                    data = data.filter(m => m.isStarred);
                }

                if (data.length < lastMessageCount || currentSearch || showOnlyStarred) {
                    list.innerHTML = '';
                    lastMessageCount = 0;
                }

                if (data.length > lastMessageCount) {
                    var newMessages = data.slice(lastMessageCount);
                    newMessages.forEach(msg => {
                        var isMe = msg.user === currentUser;
                        var rowDiv = document.createElement("div");
                        rowDiv.className = "d-flex mb-3 msg-row " + (isMe ? "justify-content-end" : "justify-content-start");
                        
                        var msgWrapper = document.createElement("div");
                        msgWrapper.className = "position-relative d-flex align-items-start " + (isMe ? "flex-row-reverse" : "flex-row");
                        msgWrapper.style.maxWidth = "75%";

                        var bubble = document.createElement("div");
                        bubble.className = "message-bubble " + (isMe ? "message-me" : "message-others");
                        
                        var contentHtml = "";
                        if(!isMe) {
                            contentHtml += `<div class="fw-bold mb-1" style="font-size: 0.75rem; color: #4e73df;">${msg.user}</div>`;
                        }

                        if(msg.message.startsWith("/uploads/")) {
                            var isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(msg.message);
                            var filename = msg.message.split('/').pop();
                            // Clean up filename UUID prefix if standard UUID (36 chars) + underscore
                            if(filename.length > 37 && filename[36] === '_') {
                                filename = filename.substring(37);
                            } else if (filename.length > 36) {
                                // Fallback for simple UUIDs without underscore separator if that was the case
                                // But commonly it's uuid_filename or just uuid-filename. 
                                // Let's just try to keep it readable. If it looks like a guid, user might accept it.
                                // The original code did substring(36) which implies 36 char UUID prefix.
                                if(filename.length > 36) filename = filename.substring(36);
                            }

                            if (isImage) {
                                contentHtml += `
                                    <div class="position-relative mt-2 group-chat-image-container">
                                        <a href="${msg.message}" target="_blank">
                                            <img src="${msg.message}" class="chat-img rounded mb-1" />
                                        </a>
                                        <a href="${msg.message}" download="${filename}" class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2 shadow-sm" title="Download" style="opacity: 0.9;">
                                            <i data-feather="download" style="width: 14px; height: 14px;"></i>
                                        </a>
                                   </div>`;
                            } else {
                                contentHtml += `
                                    <div class="attachment-card mt-2">
                                        <div class="attachment-icon-wrapper">
                                            <i data-feather="file-text" class="text-primary"></i>
                                        </div>
                                        <div class="attachment-info">
                                            <div class="attachment-name text-truncate" title="${filename}">${filename}</div>
                                            <div class="attachment-size text-muted">File</div> 
                                        </div>
                                        <a href="${msg.message}" download="${filename}" class="btn btn-sm btn-light border ms-2" title="Download">
                                            <i data-feather="download" style="width: 14px; height: 14px; color: var(--aws-orange);"></i>
                                        </a>
                                    </div>`;
                            }
                        } else {
                            contentHtml += `<div>${msg.message.replace(/\n/g, '<br>')}</div>`;
                        }
                        
                        contentHtml += `<div class="message-info text-end">${msg.timestamp}</div>`;
                        bubble.innerHTML = contentHtml;

                        // Star Button
                        var starClass = msg.isStarred ? "text-warning" : "text-muted";
                        var starBtn = document.createElement("button");
                        starBtn.onclick = function() { toggleStar(msg.id, this); };
                        starBtn.className = "btn btn-link p-0 mx-2 mt-2 star-btn " + starClass;
                        starBtn.style.textDecoration = "none";
                        starBtn.innerHTML = `<i data-feather="star" style="width:14px; height:14px; fill: ${msg.isStarred ? 'currentColor' : 'none'}"></i>`;

                        msgWrapper.appendChild(bubble);
                        msgWrapper.appendChild(starBtn);
                        rowDiv.appendChild(msgWrapper);
                        list.appendChild(rowDiv);
                    });

                    lastMessageCount = data.length;
                    feather.replace();

                    if(isScrolledToBottom) {
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }
                }
            });
    }

    fetchMessages();
    setInterval(() => {
        if(!currentSearch && !showOnlyStarred) fetchMessages();
    }, 2000);

    chatArea.addEventListener('scroll', function(){
        if(chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 50) {
            isScrolledToBottom = true;
        } else {
            isScrolledToBottom = false;
        }
    });

    document.getElementById("sendButton").addEventListener("click", sendMessage);
    document.getElementById("messageInput").addEventListener("keydown", function(e) {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        var input = document.getElementById("messageInput");
        var message = input.value;
        var group = document.getElementById("currentGroup").value;
        
        if (message.trim()) {
             var formData = new FormData();
             formData.append("message", message);
             formData.append("groupName", group);

             fetch('/Chat/SendMessage', { method: 'POST', body: formData })
             .then(() => {
                 input.value = '';
                 // If searching, clear search to see new message?
                 // For now just fetch
                 fetchMessages();
             });
        }
    }

    document.querySelectorAll('.group-link').forEach(item => {
        item.addEventListener('click', event => {
            event.preventDefault();
            document.querySelectorAll('.group-link').forEach(l => l.classList.remove('active'));
            item.classList.add('active');
            
            var group = item.getAttribute('data-group');
            document.getElementById("currentGroup").value = group;
            document.getElementById("currentRoomName").innerText = "# " + group;
            document.getElementById("messageInput").placeholder = "Type a message to #" + group + "...";
            
            // Reset message list for new group
            document.getElementById("messagesList").innerHTML = '';
            lastMessageCount = 0;
            isScrolledToBottom = true;
            
            fetchMessages();
        })
    });

    function uploadFile() {
        var input = document.getElementById('fileInput');
        var file = input.files[0];
        if(!file) return;

        var formData = new FormData();
        formData.append("file", file);

        fetch('/Chat/UploadAttachment', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if(data.url) {
                 var group = document.getElementById("currentGroup").value;
                 var formDataMsg = new FormData();
                 formDataMsg.append("message", data.url);
                 formDataMsg.append("groupName", group);

                 fetch('/Chat/SendMessage', { method: 'POST', body: formDataMsg })
                 .then(() => {
                     input.value = '';
                     fetchMessages();
                 });
            }
        });
    }
</script>

