@model OfficeSuite.Models.Project
@{
    ViewData["Title"] = Model.Name + " - Kanban Board";
    var todos = ViewBag.Todos as List<OfficeSuite.Models.Todo>;
    var statuses = ViewBag.Statuses as IEnumerable<dynamic>;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-primary mb-0">@Model.Name Board</h2>
        <p class="text-muted">Manage your project tasks visually</p>
    </div>
    <div class="d-flex gap-2">
        <a asp-action="Index" class="btn btn-outline-secondary btn-sm rounded-pill px-3"><i data-feather="arrow-left" class="me-1" style="width: 14px;"></i> Back to Projects</a>
    </div>
</div>

<div class="kanban-container d-flex gap-4 overflow-auto pb-4" style="min-height: 75vh; align-items: flex-start;">
    @foreach (var status in statuses)
    {
        var statusTodos = todos?.Where(t => t.StatusId == status.Id).ToList() ?? new List<OfficeSuite.Models.Todo>();
        
        <div class="kanban-column flex-grow-1" style="min-width: 320px; max-width: 320px;">
            <div class="kanban-header d-flex justify-content-between align-items-center mb-3 p-3 bg-white rounded-3 shadow-sm border-top border-4" style="border-top-color: @status.Color !important;">
                <h6 class="fw-bold mb-0 text-uppercase ls-1" style="color: #334155;">@status.Name</h6>
                <span class="badge rounded-pill bg-light text-dark border">@statusTodos.Count</span>
            </div>
            
            <div class="kanban-list d-flex flex-column gap-3 p-2 bg-light bg-opacity-50 rounded-3" style="min-height: 200px;" data-status-id="@status.Id" id="status-@status.Id">
                @foreach (var t in statusTodos)
                {
                    <div class="card card-modern shadow-sm border-0 kanban-card draggable" data-id="@t.Id">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge" style="background-color: @(t.StatusColor ?? "#eee"); color: #fff; font-size: 0.7rem;">@t.StatusName</span>
                                <div class="dropdown">
                                    <a href="#" class="text-muted" data-bs-toggle="dropdown"><i data-feather="more-vertical" style="width: 14px;"></i></a>
                                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                        <li><a class="dropdown-item py-2" href="/Todo/Edit?id=@t.Id"><i data-feather="edit-2" class="me-2" style="width: 14px;"></i> Edit Task</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item py-2 text-danger" href="javascript:void(0)" onclick="deleteTask(@t.Id)"><i data-feather="trash-2" class="me-2" style="width: 14px;"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                            <h6 class="fw-bold mb-2 text-dark" style="font-size: 0.95rem; line-height: 1.4;">@t.Title</h6>
                            
                            <div class="d-flex align-items-center justify-content-between mt-3 text-muted">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                                        <i data-feather="user" style="width: 12px;"></i>
                                    </div>
                                    <small style="font-size: 0.8rem;">@t.AssignedToName</small>
                                </div>
                                @if (t.IsCompleted)
                                {
                                    <i data-feather="check-circle" class="text-success" style="width: 14px;"></i>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const columns = document.querySelectorAll('.kanban-list');
            
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'bg-primary-light',
                    chosenClass: 'shadow-lg',
                    dragClass: 'opacity-50',
                    onEnd: function(evt) {
                        const taskId = evt.item.getAttribute('data-id');
                        const newStatusId = evt.to.getAttribute('data-status-id');
                        
                        if (evt.from !== evt.to) {
                            updateTaskStatus(taskId, newStatusId);
                        }
                    }
                });
            });

            function updateTaskStatus(taskId, statusId) {
                const formData = new FormData();
                formData.append('id', taskId);
                formData.append('statusId', statusId);

                fetch('/Todo/UpdateStatusAjax', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Toast or subtle indicator
                        console.log('Status updated');
                        // Refresh feather icons for new elements if any
                        feather.replace();
                    } else {
                        alert('Error updating status: ' + data.message);
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    location.reload();
                });
            }
        });

        function deleteTask(id) {
            if(confirm('Are you sure you want to delete this task?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Todo/Delete/' + id;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}

<style>
    .ls-1 { letter-spacing: 0.05rem; }
    .kanban-card { cursor: grab; transition: all 0.2s ease; border: 1px solid rgba(0,0,0,0.05) !important; }
    .kanban-card:active { cursor: grabbing; }
    .kanban-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important; }
    .kanban-container { -webkit-overflow-scrolling: touch; }
    .bg-primary-light { background-color: rgba(13, 110, 253, 0.1) !important; border: 2px dashed #0d6efd !important; }
    
    /* Modern Scrollbar */
    .kanban-container::-webkit-scrollbar { height: 8px; }
    .kanban-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .kanban-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    .kanban-container::-webkit-scrollbar-thumb:hover { background: #bbb; }
</style>

