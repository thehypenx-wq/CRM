@model OfficeSuite.Models.Todo

@{
    ViewData["Title"] = "Edit Task";
}

<div class="card card-modern">
    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
        <h4 class="mb-0">Edit Task</h4>
    </div>
    <div class="card-body px-4 pb-4">
        <form asp-action="Edit" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="Id" />
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label text-muted small">Title</label>
                    <input asp-for="Title" class="form-control" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small">Due Date</label>
                    <input asp-for="DueDate" class="form-control" type="datetime-local" value="@(Model.DueDate?.ToString("yyyy-MM-ddTHH:mm"))" />
                </div>
                 <div class="col-md-3">
                    <label class="form-label text-muted small">Status</label>
                    <select name="statusId" class="form-select">
                        @if (ViewBag.Statuses != null)
                        {
                            foreach (var s in ViewBag.Statuses)
                            {
                                if(Model.StatusId == s.Id)
                                {
                                     <option value="@s.Id" selected>@s.Name</option>
                                }
                                else
                                {
                                     <option value="@s.Id">@s.Name</option>
                                }
                            }
                        }
                    </select>
                </div>
                 <div class="col-md-4">
                    <label class="form-label text-muted small">Project</label>
                    <select name="projectId" class="form-select">
                        <option value="">No Project</option>
                        @if (ViewBag.Projects != null)
                        {
                            foreach (var p in ViewBag.Projects)
                            {
                                if(Model.ProjectId == p.Id)
                                {
                                    <option value="@p.Id" selected>@p.Name</option>
                                }
                                else
                                {
                                    <option value="@p.Id">@p.Name</option>
                                }
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                     <label class="form-label text-muted small">Assign To</label>
                    <select name="assignedToUserId" class="form-select">
                        <option value="">Unassigned</option>
                        @if (ViewBag.Users != null)
                        {
                            foreach (var u in ViewBag.Users)
                            {
                                if(Model.AssignedToUserId == u.Id)
                                {
                                    <option value="@u.Id" selected>@u.Username</option>
                                }
                                else
                                {
                                     <option value="@u.Id">@u.Username</option>
                                }
                            }
                        }
                    </select>
                </div>
                
                 <div class="col-md-4">
                    <label class="form-label text-muted small">Add Attachments</label>
                    <input type="file" name="attachments" class="form-control" multiple>
                </div>

                 <div class="col-12">
                     <label class="form-label text-muted small">Remarks History</label>
                     <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-size: 0.9rem;">
                         @Model.Remark
                     </div>
                 </div>

                 <div class="col-12">
                     <label class="form-label text-muted small">Add Comment</label>
                     <textarea name="newComment" class="form-control" rows="3" placeholder="Type a new comment..."></textarea>
                 </div>

                 <!-- Existing Attachments List -->
                 @if(Model.Attachments != null && Model.Attachments.Any())
                 {
                     <div class="col-12 mt-3">
                         <label class="form-label text-muted small">Existing Attachments</label>
                         <div class="d-flex flex-column gap-2">
                             @foreach(var att in Model.Attachments)
                             {
                                  var ext = System.IO.Path.GetExtension(att.FileName).ToLower();
                                  var isImage = (ext == ".jpg" || ext == ".png" || ext == ".jpeg" || ext == ".gif" || ext == ".webp");
                                  
                                  <div class="attachment-card bg-white">
                                      @if(isImage)
                                      {
                                          <div class="attachment-icon p-0 overflow-hidden">
                                              <img src="@att.FilePath" style="width:100%; height:100%; object-fit:cover;" />
                                          </div>
                                      }
                                      else
                                      {
                                          <div class="attachment-icon"><i data-feather="file-text" style="width:16px;"></i></div>
                                      }
                                      <div class="flex-grow-1 text-truncate">
                                          <div class="small fw-bold text-truncate" title="@att.FileName">@att.FileName</div>
                                      </div>
                                      <div class="d-flex gap-1">
                                          <a href="@att.FilePath" target="_blank" class="download-btn text-primary" title="View">
                                              <i data-feather="eye" style="width:14px;"></i>
                                          </a>
                                          <a href="@att.FilePath" download="@att.FileName" class="download-btn" title="Download">
                                              <i data-feather="download" style="width:14px;"></i>
                                          </a>
                                      </div>
                                  </div>
                             }
                         </div>
                     </div>
                 }

                <div class="col-12 mt-4 text-end">
                    <a asp-action="Index" class="btn btn-light me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary"><i data-feather="save"></i> Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Ensure feather icons load if not already handled globally in a way that catches dynamic content (though this is a full page load)
        // Global site.js handles it, but good to be safe if specific logic needed.
    </script>
}
