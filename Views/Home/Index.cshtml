@{
    ViewData["Title"] = "Dashboard";
}

<div class="text-center">
    <h1 class="display-4">Welcome to HypeNX-CRM</h1>
    <p class="text-primary fw-bold">THINK BEYOND YOUR THINKING</p>
</div>

@if (User.Identity?.IsAuthenticated == true)
{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="row mt-4">
        <!-- Tasks -->
        <div class="col-md-4 mb-4">
            <div class="card card-modern h-100 shadow-sm border-0">
                <div class="card-header card-header-modern py-3 d-flex justify-content-between align-items-center bg-white border-0">
                    <h6 class="m-0 fw-bold text-primary">Tasks Overview</h6>
                    <i data-feather="check-square" class="text-primary opacity-50"></i>
                </div>
                <div class="card-body">
                    <div style="height: 220px;">
                        <canvas id="todoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Finances -->
        <div class="col-md-4 mb-4">
            <div class="card card-modern h-100 shadow-sm border-0">
                <div class="card-header card-header-modern py-3 d-flex justify-content-between align-items-center bg-white border-0">
                    <h6 class="m-0 fw-bold text-success">Financials</h6>
                    <i data-feather="dollar-sign" class="text-success opacity-50"></i>
                </div>
                <div class="card-body">
                    <div style="height: 220px;">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Invoices -->
        <div class="col-md-4 mb-4">
            <div class="card card-modern h-100 shadow-sm border-0">
                <div class="card-header card-header-modern py-3 d-flex justify-content-between align-items-center bg-white border-0">
                    <h6 class="m-0 fw-bold text-info">Invoice Status</h6>
                    <i data-feather="file-text" class="text-info opacity-50"></i>
                </div>
                <div class="card-body">
                    <div style="height: 220px;">
                        <canvas id="invoiceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Growth Trend Chart -->
    <div class="row mt-2">
        <div class="col-md-12 mb-4">
            <div class="card card-modern shadow-sm border-0">
                <div class="card-header card-header-modern py-3 d-flex justify-content-between align-items-center bg-white border-0">
                    <h6 class="m-0 text-primary fw-bold">Financial Growth Trend</h6>
                    <small class="text-muted bg-light px-2 py-1 rounded">Last 6 Months</small>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Section -->
    <div class="row mt-4">
        <!-- Recent Tasks -->
        <div class="col-md-6 mb-4">
            <div class="card card-modern h-100 shadow-sm border-0">
                <div class="card-header card-header-modern bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-dark"><i data-feather="check-circle" class="text-primary me-2"></i>My Pending Tasks</h6>
                    <a asp-controller="Todo" asp-action="Index" class="small text-decoration-none">View All</a>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        @if(ViewBag.RecentTodos != null)
                        {
                            foreach(var t in ViewBag.RecentTodos)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                    <span class="text-truncate">@t.Title</span>
                                    <span class="badge bg-light text-muted border">@t.Date</span>
                                </li>
                            }
                        }
                    </ul>
                </div>
            </div>
        </div>

        <!-- Recent Chat -->
        <div class="col-md-6 mb-4">
             <div class="card card-modern h-100 shadow-sm border-0">
                <div class="card-header card-header-modern bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-dark"><i data-feather="message-square" class="text-info me-2"></i>Recent Group Chat</h6>
                    <a asp-controller="Chat" asp-action="Index" class="small text-decoration-none">View All</a>
                </div>
                <div class="card-body p-0">
                     <ul class="list-group list-group-flush">
                        @if(ViewBag.RecentChats != null)
                        {
                            foreach(var c in ViewBag.RecentChats)
                            {
                                <li class="list-group-item bg-transparent">
                                    <div class="d-flex justify-content-between">
                                        <small class="fw-bold text-primary">@c.User <span class="text-muted fw-normal">in #@c.Group</span></small>
                                        <small class="text-muted">@c.Time</small>
                                    </div>
                                    <p class="mb-0 small text-truncate text-muted">@c.Msg</p>
                                </li>
                            }
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <!-- Tickets Widget Row -->
    <div class="row">
         <div class="col-md-12 mb-4">
             <div class="card card-modern h-100 shadow-sm border-0">
                <div class="card-header card-header-modern bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-dark"><i data-feather="life-buoy" class="text-warning me-2"></i>Recent Tickets</h6>
                    <a asp-controller="Ticket" asp-action="Index" class="small text-decoration-none">View All</a>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 ps-3">Subject</th>
                                    <th class="border-0">Status</th>
                                    <th class="border-0">Priority</th>
                                    <th class="border-0 text-end pe-3">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if(ViewBag.RecentTickets != null)
                                {
                                    foreach(var t in ViewBag.RecentTickets)
                                    {
                                        <tr>
                                            <td class="ps-3 fw-bold text-truncate" style="max-width: 200px;">@t.Subject</td>
                                            <td><span class="badge bg-light text-dark border">@t.Status</span></td>
                                            <td>@t.Priority</td>
                                            <td class="text-end pe-3 text-muted">@t.Date</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
         <!-- Quick Links with Icons -->
        <div class="col-md-3 mb-4">
             <a asp-controller="Todo" asp-action="Index" class="text-decoration-none">
                <div class="card card-modern h-100 hover-lift border-0 shadow-sm border-start border-4 border-primary">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3 p-3 bg-light rounded-circle text-primary"><i data-feather="check-square" style="width: 24px; height: 24px;"></i></div>
                        <div>
                            <div class="h6 mb-0 text-dark fw-bold">Manage Tasks</div>
                            <small class="text-muted">Stay organized</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-4">
             <a asp-controller="Planner" asp-action="Index" class="text-decoration-none">
                <div class="card card-modern h-100 hover-lift border-0 shadow-sm border-start border-4 border-success">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3 p-3 bg-light rounded-circle text-success"><i data-feather="calendar" style="width: 24px; height: 24px;"></i></div>
                        <div>
                            <div class="h6 mb-0 text-dark fw-bold">Planner</div>
                            <small class="text-muted">Schedule events</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-4">
             <a asp-controller="Transaction" asp-action="Index" class="text-decoration-none">
                <div class="card card-modern h-100 hover-lift border-0 shadow-sm border-start border-4 border-warning">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3 p-3 bg-light rounded-circle text-warning"><i data-feather="dollar-sign" style="width: 24px; height: 24px;"></i></div>
                        <div>
                            <div class="h6 mb-0 text-dark fw-bold">Finances</div>
                            <small class="text-muted">Track money</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-4">
             <a asp-controller="Client" asp-action="Index" class="text-decoration-none">
                <div class="card card-modern h-100 hover-lift border-0 shadow-sm border-start border-4 border-info">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3 p-3 bg-light rounded-circle text-info"><i data-feather="users" style="width: 24px; height: 24px;"></i></div>
                        <div>
                            <div class="h6 mb-0 text-dark fw-bold">Clients</div>
                            <small class="text-muted">Manage database</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chartOptions = {
                maintainAspectRatio: false,
                cutout: '72%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { size: 12 }
                        }
                    }
                }
            };

            // Todo Chart
            new Chart(document.getElementById('todoChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [@ViewBag.TodoCompleted, @ViewBag.TodoPending],
                        backgroundColor: ['#1cc88a', '#f6c23e'],
                        borderWidth: 0,
                        hoverOffset: 12
                    }]
                },
                options: chartOptions
            });

            // Finance Chart (Changed to Bar)
            new Chart(document.getElementById('financeChart'), {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expense'],
                    datasets: [{
                        label: 'Amount',
                        data: [@ViewBag.TotalIncome, @ViewBag.TotalExpense],
                        backgroundColor: ['#1cc88a', '#e74a3b'],
                        borderRadius: 6,
                        borderWidth: 0,
                        barThickness: 40
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { drawBorder: false, color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11, weight: 'bold' } }
                        }
                    }
                }
            });

             // Invoice Chart (Changed to Pie)
            new Chart(document.getElementById('invoiceChart'), {
                type: 'pie',
                data: {
                    labels: ['Paid', 'Unpaid'],
                    datasets: [{
                        data: [@ViewBag.InvPaid, @ViewBag.InvUnpaid],
                        backgroundColor: ['#36b9cc', '#f44336'],
                        borderWidth: 0,
                        hoverOffset: 12
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });

            // Growth Chart
            new Chart(document.getElementById('growthChart'), {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(ViewBag.TrendMonths)),
                    datasets: [{
                        label: 'Income',
                        data: @Html.Raw(Json.Serialize(ViewBag.TrendIncomes)),
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        fill: true,
                        tension: 0.45,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }, {
                        label: 'Expense',
                        data: @Html.Raw(Json.Serialize(ViewBag.TrendExpenses)),
                        borderColor: '#e74a3b',
                        backgroundColor: 'rgba(231, 74, 59, 0.1)',
                        fill: true,
                        tension: 0.45,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { drawBorder: false, color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        });
    </script>
}
else 
{
    <div class="row mt-5 justify-content-center">
        <div class="col-md-6 text-center">
             <div class="alert alert-info shadow-sm">
                 Please <a asp-controller="Account" asp-action="Login" class="fw-bold">Login</a> or <a asp-controller="Account" asp-action="Register" class="fw-bold">Register</a> to access the features.
             </div>
        </div>
    </div>
}
